name: Publish to TestPyPI

on:
  push:
    tags:
      - "v*-testpypi"
  workflow_dispatch:
    inputs:
      version:
        description: 'Version to publish (e.g., 1.0.0)'
        required: true

permissions:
  contents: read

jobs:
  build-and-publish-testpypi:
    name: Build and Publish to TestPyPI
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"
      
      - name: Install build tools
        run: |
          python -m pip install --upgrade pip
          pip install build twine
      
      - name: Build package
        run: python -m build
      
      - name: Check package
        run: twine check dist/*
      
      - name: Publish to TestPyPI
        env:
          TWINE_USERNAME: __token__
          TWINE_PASSWORD: ${{ secrets.TESTPYPI_TOKEN }}
        run: |
          echo "Publishing to TestPyPI..."
          twine upload --repository testpypi dist/*
          echo "âœ… Published to TestPyPI"
          echo ""
          echo "Test installation:"
          echo "  pip install --index-url https://test.pypi.org/simple/ multi-agent-system"
      
      - name: Verify installation from TestPyPI
        run: |
          pip install --index-url https://test.pypi.org/simple/ --extra-index-url https://pypi.org/simple/ multi-agent-system || true
          python -c "import sys; sys.path.insert(0, '.'); from src import __version__; print(f'Version: {__version__}')" || true

